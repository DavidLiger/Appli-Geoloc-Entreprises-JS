var mymap;var latBU;var longBU;var route;var regionMarkers=[];var BUsMarkers=[];var factoryMarkers=[];var centreFRLat=46.883331;var centreFRLong=1.85;var selecArray=[];var tooMuchArray=[];var popUpBU=" ";var uniqueBU=" ";var resultsNumber;var arrayLatLong=[];var btnNivMapRegID;var btnNivMapRegNom;var btnNivMapBUNom;var btnFR="";var btnREG="";var btnBU="";var btnMultiBU="";var nivUser="";var arrayBUs=[];$(document).ready(function(){clearInput();document.getElementById('mapid').innerHTML="<div id='map' style='width: 100%; height: 100%;'></div>";var mapboxUrl='https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}';var mapboxToken='pk.eyJ1IjoiZGF2aWRsaWdlciIsImEiOiJjazI2NHk5OG8xbTZjM25ucndrb2d1dWxhIn0.AD3IDVAe3rgvwgJ59VKptA';var tileStreets=L.tileLayer(mapboxUrl,{maxZoom:18,id:'mapbox.streets',accessToken:mapboxToken});var tileSatellite=L.tileLayer(mapboxUrl,{maxZoom:18,id:'mapbox.satellite',accessToken:mapboxToken});mymap=L.map('map',{center:[centreFRLat,centreFRLong],zoom:6,layers:[tileStreets,tileSatellite],trackResize:true});var baseMaps={"Satellite":tileSatellite,"Rues":tileStreets};L.control.layers(baseMaps).addTo(mymap);tileStreets.addTo(mymap);userRightsManager();$('#entTabContainer').on('click',"#entreprises, #entrepriseID",function(){infosEnts(this);document.getElementById('entTabContainer').style.display='none';document.getElementById('mapControls').style.display='block';document.getElementById('navNiveauMap').style.display='flex';document.getElementById('btnsGenerals').style.display='flex';if(btnNivMapRegNom!=null&&btnNivMapBUNom!=null){btnsDisplayNiveauMap("F",btnNivMapRegID,btnNivMapRegNom,btnNivMapBUNom,latBU,longBU)}});$('#entTabContainer').on('click',"#divTooMuch, #btnTooMuchRes",function(){var arrayTemp=[];for(var i=0;i<tooMuchArray.length;i+=1){arrayTemp.push(tooMuchArray[i].id)}var tooMuchJSON=JSON.stringify(arrayTemp);listEntsMaker('../outil_bi/ajaxListEntsSelectSubmit.php',tooMuchJSON)});$('#displayResults').on('click',function(){document.getElementById('entTabContainer').style.display='block';document.getElementById('btnsGenerals').style.display='none';document.getElementById('mapControls').style.display='none';document.getElementById('navNiveauMap').style.display='none';})});function userRightsManager(){$.ajax({url:'../outil_bi/ajaxUserNivPer.php',datatType:'text',success:function(value){var data=value.split("|");nivUser=data[0];for(var i=1;i<data.length;i+=1){arrayBUs.push(data[i]);}if(nivUser=="dirNat"){configbtnsNiveauMap();initMapFrance()}if(nivUser=="dirReg"){if(arrayBUs.length==1){configbtnsNiveauMap();initMapRegion(arrayBUs[0])}}if(nivUser=="bu"){if(arrayBUs.length==1){configbtnsNiveauMap();uniquBU(arrayBUs[0]);}else{multipBU(JSON.stringify(arrayBUs))}}}})}function uniquBU(BU_ID){$.ajax({type:'POST',url:'../outil_bi/ajaxBUMarker.php',data:'entreprise_id='+BU_ID,success:function(value){var data=value.split("|");var latitudeBU=data[0];var longitudeBU=data[1];var popupContent=data[2];var BusID=data[3];initMapBU(latitudeBU,longitudeBU,popupContent,BusID,"N");autoViewCenter(arrayLatLong);listEntsMaker('../outil_bi/ajaxListEnts.php',BusID);RAZficheEntreprise();btnsDisplayNiveauMap("F",btnNivMapRegID,btnNivMapRegNom,popupContent,latitudeBU,longitudeBU)}})}function multipBU(arrayBU){arrayLatLong=[];$.ajax({type:'POST',url:'../outil_bi/ajaxJSONBUMarkers.php',data:'BUS_id='+arrayBU,dataType:'JSON',success:function(data){var objBus=JSON.parse(JSON.stringify(data));for(var i=0;i<objBus.length;i+=1){BUsMarkers.push(createMarkerOnMap(objBus[i].latitude,objBus[i].longitude,objBus[i].libbu,objBus[i].libbu,IconMaker("Actual",null),objBus[i].id,"A",null));arrayLatLong.push([objBus[i].latitude,objBus[i].longitude])}$('#navNiveauMap').html('<button id="btnMultiBUs" onsubmit="javascript:userRightsManager();" style="display: none"></button>');btnMultiBU=document.getElementById('btnMultiBUs');autoViewCenter(arrayLatLong)}})}function initMapFrance(){$.ajax({url:'../outil_bi/ajaxJSONFRMarkers.php',dataType:'JSON',success:function(data){var obj=JSON.parse(JSON.stringify(data));for(var i=0;i<obj.length;i+=1){regionMarkers.push(createMarkerOnMap(obj[i].latitude,obj[i].longitude,obj[i].libregion,null,IconMaker("region",obj[i].coderegion),obj[i].coderegion,"R",obj[i].zoom));mymap.addLayer(regionMarkers[i])}btnsDisplayNiveauMap("REG",regionID,btnNivMapRegNom,null,null,null)}});mymap.setView([centreFRLat,centreFRLong],6)}function initMapRegion(regionID){arrayLatLong=[];$.ajax({type:'POST',url:'../outil_bi/ajaxJSONRegionsMarker.php',data:'region_id='+regionID,dataType:'JSON',success:function(data){var objBus=JSON.parse(JSON.stringify(data));for(var i=0;i<objBus.length;i+=1){BUsMarkers.push(createMarkerOnMap(objBus[i].latitude,objBus[i].longitude,objBus[i].libbu,objBus[i].libbu,IconMaker("Actual",null),objBus[i].id,"A",null));arrayLatLong.push([objBus[i].latitude,objBus[i].longitude])}btnNivMapRegNom=objBus[0].libregion;if(regionID!=21){if(arrayLatLong.length>0){autoViewCenter(arrayLatLong);}}else{mymap.setView([13.06667,-59.53333],5)}btnsDisplayNiveauMap("REG",regionID,btnNivMapRegNom,null,null,null)}})}function initMapBU(latitude,longitude,popucontent,BUsID,isFromMap){if(popUpBU==" "){popUpBU=" <div style='display: flex;flex-direction: column;justify-content: space-around'>						<span style='font-size:1.2em;text-align: center'>"+popucontent+"</span>						<span style='font-size:0.8em;text-align: center'>Cliquez pour obtenir</span>						<span style='font-size:0.8em;text-align: center'>les stats de cette BU</span></div>"}if(uniqueBU==" "){arrayLatLong=[];arrayLatLong.push([latitude,longitude]);uniqueBU=createMarkerOnMap(latitude,longitude,popUpBU,popucontent,IconMaker("Actual",null),BUsID,"A")}if(isFromMap=="Y"){document.getElementById('displayResults').innerHTML="Afficher les "+resultsNumber+" résultats";listEntsMaker('../outil_bi/ajaxListEnts.php',BUsID);RAZficheEntreprise();mymap.setView([latitude,longitude],13)}}function listEntsMaker(AjaxUrl,CodeID){var msg="entreprises rattachées à cette Business Unit";if(AjaxUrl=='../outil_bi/ajaxListEntsSelectSubmit.php'){msg="résultats"}$.ajax({type:'POST',url:AjaxUrl,data:'code_id='+CodeID,success:function(html){$('#entTabContainer').html(html);$("#tableEntreprises").DataTable({language:{processing:"Traitement en cours...",search:"Rechercher&nbsp;:",lengthMenu:"Afficher _MENU_ &eacute;l&eacute;ments",info:"Affichage de l'&eacute;lement _START_ &agrave; _END_ sur _TOTAL_ &eacute;l&eacute;ments",infoEmpty:"Affichage de l'&eacute;lement 0 &agrave; 0 sur 0 &eacute;l&eacute;ments",infoFiltered:"(filtr&eacute; de _MAX_ &eacute;l&eacute;ments au total)",infoPostFix:"",loadingRecords:"Chargement en cours...",zeroRecords:"Aucun &eacute;l&eacute;ment &agrave; afficher",emptyTable:"Aucune donnée disponible dans le tableau",paginate:{first:"Premier",previous:"Pr&eacute;c&eacute;dent",next:"Suivant",last:"Dernier"},aria:{sortAscending:": activer pour trier la colonne par ordre croissant",sortDescending:": activer pour trier la colonne par ordre décroissant"}}});var table=$('#tableEntreprises').DataTable();var resultsNumber=table.column(0).data().length;document.getElementById('displayResults').innerHTML="Afficher les "+resultsNumber+" "+msg;document.getElementById('entTabContainer').style.display='none';document.getElementById('btnsGenerals').style.display='flex';document.getElementById('mapControls').style.display='block';clearNotice()}})}function IconMaker(type,iconType){var icon;if(type=="factory"){icon=L.icon({iconUrl:'../outil_bi/images/factory-marker.png',shadowUrl:'../outil_bi/images/factory-marker-shadow.png',iconSize:[36,49],shadowSize:[73,49],iconAnchor:[18,49],shadowAnchor:[36,50],popupAnchor:[2,-49]})}if(type=="Actual"){icon=L.icon({iconUrl:'../outil_bi/images/Actual-marker.png',shadowUrl:'../outil_bi/images/Actual-marker-shadow.png',iconSize:[38,50],shadowSize:[90,52],iconAnchor:[19,50],shadowAnchor:[45,50],popupAnchor:[2,-50]})}if(type=="region"){if(iconType!=21){icon=L.icon({iconUrl:'../outil_bi/images/region-'+iconType+'-marker.png',shadowUrl:'../outil_bi/images/region-marker-shadow.png',iconSize:[180,104],shadowSize:[180,104],iconAnchor:[90,104],shadowAnchor:[90,104],popupAnchor:[2,-104]})}else{icon=L.icon({iconUrl:'../outil_bi/images/region-'+iconType+'-marker.png',shadowUrl:'../outil_bi/images/region-21-marker-shadow.png',iconSize:[180,104],shadowSize:[180,104],iconAnchor:[90,104],shadowAnchor:[90,104],popupAnchor:[2,-104]})}}return icon};function createMarkerOnMap(latitude,longitude,popupContent,libBU,icon,CodeID,type){var marker=L.marker([latitude,longitude],{icon:icon}).addTo(mymap).bindPopup(popupContent);marker.on('mouseover',function(e){this.openPopup()});marker.on('mouseout',function(e){this.closePopup()});if(type=="R"){marker.on('click',function(e){btnsDisplayNiveauMap("REG",btnNivMapRegID,btnNivMapRegNom,null,null,null);deleteRegionMarkers();initMapRegion(CodeID);autoViewCenter(arrayLatLong)})}if(type=="A"){marker.on('click',function(e){btnsDisplayNiveauMap("BU",btnNivMapRegID,btnNivMapRegNom,libBU,latitude,longitude);deleteBUsMarkers();initMapBU(latitude,longitude,popupContent,CodeID,"Y");$('#mapid').width("100%");autoViewCenter(arrayLatLong);if(btnMultiBU!=""){btnMultiBU.innerHTML="Mes "+arrayBUs.length+" Business Units";btnMultiBU.style.display='block'}})}if(type=="F"){marker.on('click',function(e){if(btnNivMapRegNom!=null&&btnNivMapBUNom!=null){btnsDisplayNiveauMap("F",btnNivMapRegID,btnNivMapRegNom,btnNivMapBUNom,latBU,longBU)}displayFicheEntreprise(CodeID);mymap.setView([latitude,longitude],13)})}return marker}function RAZficheEntreprise(){var raz="RAZ";$.ajax({type:'POST',url:'../outil_bi/ajaxFicheEntreprise.php',data:'entreprise_id='+raz,success:function(html){$('#entrepriseData').html(html)}})}function displayFicheEntreprise(entrepriseID){$.ajax({type:'POST',url:'../outil_bi/ajaxFicheEntreprise.php',data:'entreprise_id='+entrepriseID,success:function(html){$('#entrepriseData').html(html);clearFiche();displayBtnSaveFiche(entrepriseID);autoViewCenter(arrayLatLong);autoSetMapHeight();}})}function validateFormOnSubmit(){arrayLatLong=[];var search=document.getElementById('selectEnt').value;if(search){deleteRegionMarkers();deleteBUsMarkers();deleteFactoryMarkers();deleteUniqueBU();$('#entTabContainer').empty();document.getElementById('mapControls').style.display='none';document.getElementById('entTabContainer').style.display='block';RAZficheEntreprise();initMapFrance();btnsDisplayNiveauMap("REG",btnNivMapRegID,btnNivMapRegNom,null,null,null);$.ajax({type:'POST',url:'../outil_bi/ajaxSEQuery.php',data:'search='+search,dataType:'JSON',success:function(data){var objBus=JSON.parse(JSON.stringify(data));tooMuchArray=objBus;if(objBus.length==0){$('#entTabContainer').html("<label style='margin-left: 5%;height: 100%;display: flex;align-items: center;justify-content: center;'>Nous n'avons pas trouvé de résultats : essayez des termes différents</label>")}else if(objBus.length>=20&&objBus.length<1000){$('#entTabContainer').html("<div id='divTooMuch' style='display: flex; flex-direction: row; align-content: space-between'><span style='margin-left: 5%;height: 100%;display: flex;align-items: center;justify-content: center;'>Nous avons trouvé plus de 20 résultats : affiner votre recherche ou </span><button style='margin-left: 2%;padding: 2px 42px;border-radius: 10px;' id='btnTooMuchRes'>Génerer une liste</button></div>")}else if(objBus.length>1000){$('#entTabContainer').html("<div id='divTooMuch' style='display: flex; flex-direction: row; align-content: space-between'><span style='margin-left: 5%;height: 100%;display: flex;align-items: center;justify-content: center;'>Plus de 1000 résultats. Merci d'affiner votre recherche</span></div>")}else{for(var i=0;i<objBus.length;i+=1){factoryMarkers.push(createMarkerOnMap(objBus[i].latitude,objBus[i].longitude,objBus[i].nom,null,IconMaker("factory",null),objBus[i].id,"F",null));arrayLatLong[i]=([objBus[i].latitude,objBus[i].longitude])}}if(arrayLatLong.length>0){autoViewCenter(arrayLatLong);}}})}}function infosEnts(param){deleteRegionMarkers();var entrepriseID=$(param).val();$.ajax({type:'POST',url:'../outil_bi/ajaxEntrepriseMarker.php',data:'entreprise_id='+entrepriseID,success:function(value){var data=value.split("|");var latitudeEntreprise=data[0];var longitudeEntreprise=data[1];var popupContent=data[2];factoryMarkers.push(createMarkerOnMap(latitudeEntreprise,longitudeEntreprise,popupContent,null,IconMaker("factory",null),entrepriseID,"F",null));displayFicheEntreprise(entrepriseID);arrayLatLong.push([latitudeEntreprise,longitudeEntreprise]);if(arrayLatLong.length>0){autoViewCenter(arrayLatLong);}}})}function deleteRegionMarkers(){for(var i=0;i<regionMarkers.length;i+=1){mymap.removeLayer(regionMarkers[i])}}function deleteBUsMarkers(){if(Array.isArray(BUsMarkers)&&BUsMarkers.length){for(var i=0;i<BUsMarkers.length;i+=1){mymap.removeLayer(BUsMarkers[i])}}}function deleteUniqueBU(){if(uniqueBU!=" "){mymap.removeLayer(uniqueBU);uniqueBU=" ";popUpBU=" "}}function deleteFactoryMarkers(){if(Array.isArray(factoryMarkers)&&factoryMarkers.length){for(var i=0;i<factoryMarkers.length;i+=1){mymap.removeLayer(factoryMarkers[i])}}}function clearInput(){jQuery(function($){function tog(v){return v?'addClass':'removeClass'}$(document).on('input','.clearable',function(){$(this)[tog(this.value)]('x')}).on('mousemove','.x',function(e){$(this)[tog(this.offsetWidth-36<e.clientX-this.getBoundingClientRect().left)]('onX')}).on('touchstart click','.onX',function(ev){ev.preventDefault();$(this).removeClass('x onX').val('').change()})})}function clearFiche(){var btn=document.getElementById('btnCloseFiche');btn.onclick=function(e){RAZficheEntreprise();$('#entrepriseData').empty();$('#mapid').width("100%");autoViewCenter(arrayLatLong)}}function clearNotice(){var btn=document.getElementById('btnCloseNotice');btn.onclick=function(e){RAZficheEntreprise();$('#notice').empty();}}function displayBtnSaveFiche(entrepriseID){var input=document.getElementById('inputFiche');var select=document.getElementById('selectFiche');input.oninput=function(e){document.getElementById('btnSaveFiche').style.display='block';autoSetMapHeight();saveFiche(entrepriseID,input,select)};select.onchange=function(e){document.getElementById('btnSaveFiche').style.display='block';autoSetMapHeight();saveFiche(entrepriseID,input,select)}}function saveFiche(entrepriseID,input,select){var btnSaveFiche=document.getElementById('btnSaveFiche');var queryValues=[];btnSaveFiche.onclick=function(e){queryValues.push(entrepriseID);var inputValue=input.value;var selectValue=select.options[select.selectedIndex].value;queryValues.push(inputValue);queryValues.push(selectValue);var entIDuserIDuserNomConcat=JSON.stringify(queryValues);$.ajax({type:'POST',url:'../outil_bi/ajaxInsertFromFiche.php',data:'idNomConcat='+entIDuserIDuserNomConcat,dataType:'text',success:function(html){alert('Vos modifications ont bien été enregistrées !')}})}}function GetCenterFromDegrees(data){if(!(data.length>0)){return false}var num_coords=data.length;var X=0.0;var Y=0.0;var Z=0.0;for(i=0;i<data.length;i+=1){var lat=data[i][0]*Math.PI/180;var lon=data[i][1]*Math.PI/180;var a=Math.cos(lat)*Math.cos(lon);var b=Math.cos(lat)*Math.sin(lon);var c=Math.sin(lat);X+=a;Y+=b;Z+=c}X/=num_coords;Y/=num_coords;Z/=num_coords;var lon=Math.atan2(Y,X);var hyp=Math.sqrt(X*X+Y*Y);var lat=Math.atan2(Z,hyp);var newX=(lat*180/Math.PI);var newY=(lon*180/Math.PI);return[newX,newY]}function autoZoom(data){if(!(data.length>0)){return false}var minLat=data[0][0];var maxLat=data[0][0];var minLong=data[0][1];var maxLong=data[0][1];var zoom;var prodMax=0;for(i=0;i<data.length;i+=1){if(data[i][0]<minLat){minLat=data[i][0]}if(data[i][0]>maxLat){maxLat=data[i][0]}if(data[i][1]<minLong){minLong=data[i][1]}if(data[i][1]>maxLong){maxLong=data[i][1]}}var prodLat=maxLat-minLat;var prodLong=maxLong-minLong;if(prodLat<0){prodLat=Math.abs(prodLat)}if(prodLong<0){prodLong=Math.abs(prodLong)}prodMax=prodLat;if(prodLong>prodMax){prodMax=prodLong}if(prodMax<0.1){zoom=11}if(prodMax>0.1&&prodMax<0.7){zoom=10}if(prodMax>0.7&&prodMax<1.15){zoom=9}if(prodMax>1.15&&prodMax<1.8){zoom=8}if(prodMax>1.8&&prodMax<4.25){zoom=7}if(prodMax>4.25&&prodMax<14){zoom=6}if(prodMax>14&&prodMax<25){zoom=4}return zoom}function autoViewCenter(arrayMarkers){setTimeout(function(){mymap.invalidateSize()},10);mymap.setView(GetCenterFromDegrees(arrayMarkers),autoZoom(arrayMarkers))}function autoSetMapHeight(){$('#mapid').width("52%");$('#fiche').width("100%");$('#mapid').height(Math.round($('#fiche').height()))}function configbtnsNiveauMap(){var btnsNiveauMapDiv=document.getElementById('navNiveauMap');if(nivUser=="dirNat"){$('#navNiveauMap').html("<button id='btnNivFR'>France</button><button id='btnNivRegion'>Region</button><button id='btnNivBU'>Business Unit</button>");btnFR=document.getElementById('btnNivFR');btnREG=document.getElementById('btnNivRegion');btnBU=document.getElementById('btnNivBU')}else if(nivUser=="dirReg"){$('#navNiveauMap').html("<button id='btnNivRegion'>Region</button><button id='btnNivBU'>Business Unit</button>");btnREG=document.getElementById('btnNivRegion');btnBU=document.getElementById('btnNivBU')}else{$('#navNiveauMap').html("<button id='btnNivBU'>Business Unit</button>");btnBU=document.getElementById('btnNivBU')}}function btnsDisplayNiveauMap(niveau,regionID,regNom,BUnom,latitude,longitude){btnNivMapRegID=regionID;latBU=latitude;longBU=longitude;btnNivMapRegNom=regNom;btnNivMapBUNom=BUnom;if(btnREG!=""){btnREG.innerHTML="Région "+btnNivMapRegNom}if(btnBU!=""){btnBU.innerHTML="Agence "+btnNivMapBUNom}if(niveau=="REG"){if(btnFR!=""){btnFR.style.display='block'}if(btnREG!=""){btnREG.style.display='none'}if(btnBU!=""){btnBU.style.display='none'}}if(niveau=="BU"){if(btnFR!=""){btnFR.style.display='block'}if(btnREG!=""){btnREG.style.display='block'}if(btnBU!=""){btnBU.style.display='none'}}if(niveau=="F"){if(btnFR!=""){btnFR.style.display='block'}if(btnREG!=""){btnREG.style.display='block'}if(btnBU!=""){btnBU.style.display='block'}}btnFR.onclick=function(e){deleteRegionMarkers();deleteBUsMarkers();deleteUniqueBU();deleteFactoryMarkers();initMapFrance();$('#mapid').width("100%");RAZficheEntreprise();btnFR.style.display='none';btnREG.style.display='none';btnBU.style.display='none';document.getElementById('mapControls').style.display='none';setTimeout(function(){mymap.invalidateSize()},400);$('#selectEnt').val('');};btnREG.onclick=function(e){deleteRegionMarkers();deleteBUsMarkers();deleteUniqueBU();deleteFactoryMarkers();initMapRegion(btnNivMapRegID);$('#mapid').width("100%");RAZficheEntreprise();btnFR.style.display='block';btnREG.style.display='none';btnBU.style.display='none';document.getElementById('mapControls').style.display='none'};btnBU.onclick=function(e){mymap.setView([latBU,longBU],13);btnFR.style.display='block';btnREG.style.display='block';btnBU.style.display='none'};btnMultiBU.onclick=function(e){arrayBUs=[];deleteUniqueBU();deleteFactoryMarkers();userRightsManager();$('#mapid').width("100%");RAZficheEntreprise()}}